const { OUTPUT_DIR } = require('./constants');
const { getUrlSafeFileName } = require('./utils');
const { buildSingleExtension } = require('./build');
const path = require('path');
const manifestPlugin = require('./plugins/manifestPlugin');

async function remoteBuild(root, entryPoint, outputDir) {
  const allowedExtensions = ['.js', '.ts', '.tsx', '.jsx'];
  const fileInfo = path.parse(entryPoint);

  if (!allowedExtensions.includes(fileInfo.ext)) {
    throw new Error(
      `The last argument should be the filename you wish to build.  Supported file extensions are [${allowedExtensions.join(
        ', '
      )}]`
    );
  }

  await buildSingleExtension({
    file: entryPoint,
    outputFileName: getUrlSafeFileName(entryPoint),
    outputDir: outputDir || OUTPUT_DIR,
    plugins: {
      rollup: [manifestPlugin({ minify: true })],
    },
    minify: true,
    root,
  });
}

module.exports = {
  remoteBuild,
};
