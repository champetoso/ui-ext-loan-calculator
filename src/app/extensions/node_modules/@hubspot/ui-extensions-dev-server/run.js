#!/usr/bin/env node

const { startDevMode } = require('./dev');
const { loadConfig } = require('./config');
const { buildAllExtensions, buildSingleExtension } = require('./build');
const { VITE_DEFAULT_PORT, OUTPUT_DIR } = require('./constants');
const { parseArgs, showHelp } = require('./cli');
const { getUrlSafeFileName } = require('./utils');
const manifestPlugin = require('./plugins/manifestPlugin');

const { DEV_MODE, BUILD_MODE, port, extension, help } = parseArgs();
const PORT = port || VITE_DEFAULT_PORT;

if (help || !(DEV_MODE || BUILD_MODE)) {
  showHelp(OUTPUT_DIR);
}

if (DEV_MODE) {
  startDevMode(loadConfig(), OUTPUT_DIR, PORT, extension);
} else if (BUILD_MODE) {
  if (extension) {
    buildSingleExtension({
      file: extension,
      outputFileName: getUrlSafeFileName(extension),
      outputDir: OUTPUT_DIR,
      plugins: { rollup: [manifestPlugin()] },
    });
  } else {
    buildAllExtensions(loadConfig(), OUTPUT_DIR);
  }
}
